#!/bin/bash
#
# dotfiles-sync
# Watches chezmoi source directory for changes and pushes to remote.
# Requires: inotify-tools, git, chezmoi

set -euo pipefail

CHEZMOI_DIR="${CHEZMOI_DIR:-$HOME/.local/share/chezmoi}"
LOG_FILE="${LOG_FILE:-$HOME/.local/state/dotfiles-sync.log}"
DEBOUNCE_SECONDS="${DEBOUNCE_SECONDS:-1200}"
LOCK_FILE="/tmp/dotfiles-sync.lock"

mkdir -p "$(dirname "$LOG_FILE")"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

cleanup() {
    rm -f "$LOCK_FILE"
    exit 0
}

trap cleanup SIGTERM SIGINT

if [ -f "$LOCK_FILE" ]; then
    log "Already running (pid: $(cat "$LOCK_FILE"))"
    exit 1
fi
echo $$ > "$LOCK_FILE"

sync_changes() {
    cd "$CHEZMOI_DIR" || return 1

    if [ -z "$(git status --porcelain)" ]; then
        return 0
    fi

    git add -A
    git commit -m "sync: $(date '+%Y-%m-%d %H:%M')" --no-gpg-sign

    if git push 2>&1; then
        log "Pushed"
    else
        log "Push failed"
    fi
}

log "Started (debounce: ${DEBOUNCE_SECONDS}s)"
sync_changes

inotifywait -m -r -e modify,create,delete,move "$CHEZMOI_DIR" \
    --exclude '\.git' 2>/dev/null | while read -r; do
    sleep "$DEBOUNCE_SECONDS"
    sync_changes
done
