#!/bin/bash
# Dotfiles auto-sync: watches source files, syncs changes to GitHub

CHEZMOI_DIR="$HOME/.local/share/chezmoi"
LOG="$HOME/.local/state/dotfiles-sync.log"
LOCK="/tmp/dotfiles-sync.lock"
DEBOUNCE="${DEBOUNCE:-60}"

mkdir -p "$(dirname "$LOG")"
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG"; }
cleanup() { rm -f "$LOCK"; exit 0; }
trap cleanup SIGTERM SIGINT

[ -f "$LOCK" ] && { log "Already running"; exit 1; }
echo $$ > "$LOCK"
log "Started"

sync_changes() {
    cd "$CHEZMOI_DIR" || return

    # Re-add changed files and auto-add new files in tracked dirs
    chezmoi re-add 2>/dev/null
    chezmoi managed --include=dirs | while read -r dir; do
        chezmoi unmanaged "$HOME/$dir" 2>/dev/null | while read -r f; do
            [ -f "$HOME/$f" ] && chezmoi add "$HOME/$f" 2>/dev/null && log "Auto-added $f"
        done
    done

    # Commit and push
    [ -n "$(git status --porcelain)" ] && {
        changed_files=$(git status --porcelain | awk '{print $2}' | xargs -n1 basename | sort -u | tr '\n' ', ' | sed 's/, $//')
        git add -A
        git commit -m "auto: sync $(date '+%Y-%m-%d %H:%M')" --no-gpg-sign
        git push 2>&1 && { log "Pushed"; notify-send -t 5000 "backed tf up" "$changed_files"; } || log "Push failed"
    }
}

sync_changes

# Watch chezmoi dir + top-level source directories only (not nested subdirs)
WATCH_DIRS="$CHEZMOI_DIR"
for dir in .claude .config .local/bin .local/share/waybar-layouts; do
    [ -d "$HOME/$dir" ] && WATCH_DIRS="$WATCH_DIRS $HOME/$dir"
done

# Simple approach: sync every DEBOUNCE seconds if there are changes
while true; do
    sleep "$DEBOUNCE"
    sync_changes
done
