#!/bin/bash
#
# dotfiles-sync
# Watches source files, syncs changes to chezmoi, pushes to git remote.
# Requires: inotify-tools, git, chezmoi, libnotify (optional)

set -uo pipefail

CHEZMOI_DIR="${CHEZMOI_DIR:-$HOME/.local/share/chezmoi}"
LOG_FILE="${LOG_FILE:-$HOME/.local/state/dotfiles-sync.log}"
DEBOUNCE="${DEBOUNCE:-60}"
LOCK="/tmp/dotfiles-sync.lock"

mkdir -p "$(dirname "$LOG_FILE")"
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"; }
cleanup() { rm -f "$LOCK"; exit 0; }
trap cleanup SIGTERM SIGINT

[ -f "$LOCK" ] && { log "Already running"; exit 1; }
echo $$ > "$LOCK"
log "Started"

sync_changes() {
    cd "$CHEZMOI_DIR" || return

    # Re-add changed files from source
    chezmoi re-add 2>/dev/null

    # Auto-add new files in tracked directories
    chezmoi managed --include=dirs | while read -r dir; do
        chezmoi unmanaged "$HOME/$dir" 2>/dev/null | while read -r f; do
            [ -f "$HOME/$f" ] && chezmoi add "$HOME/$f" 2>/dev/null && log "Auto-added $f"
        done
    done

    # Commit and push if changes exist
    [ -n "$(git status --porcelain)" ] && {
        git add -A
        git commit -m "auto: sync $(date '+%Y-%m-%d %H:%M')" --no-gpg-sign
        if git push 2>&1; then
            log "Pushed"
            command -v notify-send >/dev/null && notify-send -t 5000 "Dotfiles synced" "$(git log -1 --format='%s')"
        else
            log "Push failed"
        fi
    }
}

sync_changes

# Build watch list: chezmoi dir + all tracked source directories
WATCH_DIRS="$CHEZMOI_DIR"
while read -r dir; do
    [ -d "$HOME/$dir" ] && WATCH_DIRS="$WATCH_DIRS $HOME/$dir"
done < <(chezmoi managed --include=dirs)

# Watch with proper debouncing
while true; do
    inotifywait -r -q -e modify,create,delete,move $WATCH_DIRS \
        --exclude '\.git|node_modules|__pycache__|\.cache' 2>/dev/null
    while inotifywait -r -q -t "$DEBOUNCE" -e modify,create,delete,move $WATCH_DIRS \
        --exclude '\.git|node_modules|__pycache__|\.cache' 2>/dev/null; do :; done
    sync_changes
done
